name: Journal Fast Refresh

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

jobs:
  refresh:
    runs-on: ubuntu-latest
    env:
      SNAPTRADE_CLIENT_ID: ${{ secrets.SNAPTRADE_CLIENT_ID }}
      SNAPTRADE_CONSUMER_KEY: ${{ secrets.SNAPTRADE_CONSUMER_KEY }}
      SNAPTRADE_USER_ID: ${{ secrets.SNAPTRADE_USER_ID }}
      SNAPTRADE_USER_SECRET: ${{ secrets.SNAPTRADE_USER_SECRET }}
      NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
      NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      NOTION_WEEKLY_REVIEWS_PAGE_ID: ${{ secrets.NOTION_WEEKLY_REVIEWS_PAGE_ID }}
      NOTION_TIMEZONE: America/New_York
      SNAPTRADE_INCLUDE_ALL: "1"
      SNAPTRADE_FETCH_START_DATE: "2025-01-01"
      SNAPTRADE_START_DATE: "2025-01-01"
      SNAPTRADE_FRESHNESS_HOURS: "72"
      SNAPTRADE_FRESHNESS_FAIL_ON_STALE: "0"
    steps:
      - name: Guard Market Hours ET (Mon-Fri 9:30-16:15) + After-Hours (20:30, 05:00)
        id: guard
        run: |
          # If you manually click "Run workflow", always run (don't skip due to time windows).
          if [ "${GITHUB_EVENT_NAME:-}" = "workflow_dispatch" ]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            echo "run_full=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          DOW="$(TZ=America/New_York date +%u)"
          HOUR="$(TZ=America/New_York date +%H)"
          MIN="$(TZ=America/New_York date +%M)"

          SHOULD_RUN=false
          RUN_FULL=false

          if [ "$DOW" -ge 1 ] && [ "$DOW" -le 5 ]; then
            # Market hours
            if [ "$HOUR" -gt 9 ] && [ "$HOUR" -lt 16 ]; then
              SHOULD_RUN=true
            elif [ "$HOUR" -eq 9 ] && [ "$MIN" -ge 30 ]; then
              SHOULD_RUN=true
            elif [ "$HOUR" -eq 16 ] && [ "$MIN" -le 15 ]; then
              SHOULD_RUN=true
            fi

            # After-hours catch-up runs.
            # GitHub scheduled workflows can start a few minutes late, so allow a small window.
            # 20:30 ET window: 20:30-20:44
            # 05:00 ET window: 05:00-05:14
            if { [ "$HOUR" -eq 20 ] && [ "$MIN" -ge 30 ] && [ "$MIN" -lt 45 ]; } || { [ "$HOUR" -eq 5 ] && [ "$MIN" -ge 0 ] && [ "$MIN" -lt 15 ]; }; then
              SHOULD_RUN=true
              RUN_FULL=true
            fi
          fi

          if [ "$SHOULD_RUN" = true ]; then
            if [ "$MIN" = "00" ] || { [ "$HOUR" = "16" ] && [ "$MIN" = "15" ]; }; then
              RUN_FULL=true
            fi
          fi

          echo "should_run=$SHOULD_RUN" >> "$GITHUB_OUTPUT"
          echo "run_full=$RUN_FULL" >> "$GITHUB_OUTPUT"

      - uses: actions/checkout@v4
        if: steps.guard.outputs.should_run == 'true'

      - uses: actions/setup-node@v4
        if: steps.guard.outputs.should_run == 'true'
        with:
          node-version: "20"
          cache: "npm"

      - run: npm ci
        if: steps.guard.outputs.should_run == 'true'

      - name: Import Public API
        if: steps.guard.outputs.should_run == 'true'
        run: npm run import-public-api

      - name: Import Robinhood API
        if: steps.guard.outputs.should_run == 'true'
        run: npm run import-robinhood-api

      - name: Import Fidelity API
        if: steps.guard.outputs.should_run == 'true'
        run: npm run import-fidelity-api

      - name: Reconcile Open Positions
        if: steps.guard.outputs.should_run == 'true'
        run: npm run reconcile-open

      - name: Rebuild Daily Summary
        if: steps.guard.outputs.run_full == 'true'
        run: npm run rebuild-daily-summary

      - name: Audit Journal
        if: steps.guard.outputs.run_full == 'true'
        run: npm run audit-journal

      - name: Freshness Check
        if: steps.guard.outputs.run_full == 'true'
        run: npm run freshness-check
